
      // Modified saveToNetlify to include Google Sheets logic via API
      async function saveToNetlify() {
        const base = (function(){ try { return (localStorage.getItem('API_BASE') || '').trim() } catch(_) { return '' } })()
        
        // 1. Try saving via Vercel API (which handles MongoDB + Google Sheets)
        if (base) {
          try {
            const url = new URL('/api/enroll', base).toString()
            // Convert payload to match API spec
            const apiPayload = {
              enrollmentId: payload.enrollment_no || payload.employee_no || payload.phone || payload.parent_phone || ('UNK-' + Date.now()),
              studentName: payload.name || payload.student_name || payload.parent_name || 'Unknown',
              phone: payload.phone || payload.parent_phone || '0000000000',
              email: 'no-email@provided.com', // Placeholder as frontend doesn't capture email yet
              sector: 'allimi sector', // Default per request
              employeeNumber: payload.employee_no || 'N/A'
            }
            
            const res = await fetch(url, { 
              method: 'POST', 
              headers: { 'Content-Type': 'application/json' }, 
              body: JSON.stringify(apiPayload) 
            })
            
            const json = await res.json().catch(() => ({}))
            if (res.ok && json.success) {
              // If API save worked, we consider it done.
              return { success: true, duplicate: false }
            }
            if (res.status === 409 || (json && json.duplicate)) {
              return { success: false, duplicate: true, existingRegNo: json.existingRegNo || '' }
            }
          } catch (_) {
            console.log('API save failed, falling back to local storage')
          }
        }

        // 2. Fallback: Save to LocalStorage if API fails or not configured
        try {
          const raw = localStorage.getItem('registrations')
          const list = raw ? JSON.parse(raw) : []
          const isDup = (a, b) => {
            if (!a || !b) return false
            const eq = (x, y) => String(x || '').trim().toLowerCase() === String(y || '').trim().toLowerCase()
            if (a.enrollment_no && b.enrollment_no && eq(a.enrollment_no, b.enrollment_no)) return true
            if (a.phone && b.phone && eq(a.phone, b.phone)) return true
            if (a.parent_phone && b.parent_phone && eq(a.parent_phone, b.parent_phone)) return true
            if (a.employee_no && b.employee_no && eq(a.employee_no, b.employee_no)) return true
            const an = (a.name || a.student_name || '').trim().toLowerCase()
            const bn = (b.name || b.student_name || '').trim().toLowerCase()
            const al = (a.last_class || a.student_class || '').trim().toLowerCase()
            const bl = (b.last_class || b.student_class || '').trim().toLowerCase()
            if (an && bn && al && bl && an === bn && al === bl) return true
            return false
          }
          const existing = list.find(item => isDup(item, payload))
          if (existing) return { success: false, duplicate: true, existingRegNo: existing.reg_no || '' }
          list.push(payload)
          localStorage.setItem('registrations', JSON.stringify(list))
          return { success: true, duplicate: false }
        } catch (_) { return { success: false, duplicate: false } }
      }
