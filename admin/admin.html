<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Registrations</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <header class="py-6 px-6 max-w-6xl mx-auto flex items-center justify-between">
    <div class="text-2xl font-bold text-blue-900">Admin Panel</div>
    <div class="flex items-center gap-3">
      <a href="/static-site/student-data.xlsx" class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-white font-semibold hover:bg-blue-700">Download Student Data Excel</a>
      <a href="/static-site/export.xlsx" class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-white font-semibold hover:bg-green-700">Download Excel</a>
      <button id="deleteAll" class="inline-flex items-center rounded-md bg-red-600 px-4 py-2 text-white font-semibold hover:bg-red-700">Delete All</button>
      <a href="/" class="inline-flex items-center rounded-md border border-blue-200 px-4 py-2 text-blue-700">Back</a>
    </div>
  </header>
  <main class="max-w-6xl mx-auto px-6">
    <div id="status" class="mb-3 text-sm"></div>
    <div class="mb-4 rounded-md border border-blue-200 bg-white p-4">
      <div class="text-blue-900 font-semibold mb-2">Add Student to Roster (fallback when Excel missing)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="rosterEnrollment" type="text" placeholder="Enrollment No" class="rounded-md border border-blue-300 px-2 py-1" />
        <input id="rosterName" type="text" placeholder="Student Name" class="rounded-md border border-blue-300 px-2 py-1" />
        <input id="rosterClass" type="text" placeholder="Class (optional)" class="rounded-md border border-blue-300 px-2 py-1" />
      </div>
      <div class="mt-3">
        <button id="rosterAddBtn" class="rounded-md bg-blue-600 px-3 py-1.5 text-white font-semibold hover:bg-blue-700">Add to Roster</button>
        <span id="rosterMsg" class="ml-3 text-sm"></span>
      </div>
    </div>
    <div class="mb-4 rounded-md border border-blue-200 bg-white p-4">
      <div class="text-blue-900 font-semibold mb-2">Upload Roster File (CSV/JSON)</div>
      <div class="flex items-center gap-3">
        <input id="rosterFile" type="file" accept=".csv,.json,application/json,text/csv" class="rounded-md border border-blue-300 px-2 py-1" />
        <button id="rosterUploadBtn" class="rounded-md bg-blue-600 px-3 py-1.5 text-white font-semibold hover:bg-blue-700">Upload File</button>
        <span id="rosterUploadMsg" class="ml-3 text-sm"></span>
      </div>
    </div>
    <div class="overflow-x-auto rounded-md border border-gray-200 bg-white">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="px-3 py-2 text-left">Timestamp</th>
            <th class="px-3 py-2 text-left">Type</th>
            <th class="px-3 py-2 text-left">Enrollment No</th>
            <th class="px-3 py-2 text-left">Name</th>
            <th class="px-3 py-2 text-left">Phone</th>
            <th class="px-3 py-2 text-left">Age</th>
            <th class="px-3 py-2 text-left">Employee No</th>
            <th class="px-3 py-2 text-left">Last Class</th>
            <th class="px-3 py-2 text-left">Organisation</th>
            <th class="px-3 py-2 text-left">Address</th>
            <th class="px-3 py-2 text-left">Parent Name</th>
            <th class="px-3 py-2 text-left">Parent Phone</th>
            <th class="px-3 py-2 text-left">Student Name</th>
            <th class="px-3 py-2 text-left">Student Class</th>
            <th class="px-3 py-2 text-left">Competitions</th>
          </tr>
        </thead>
        <tbody id="rows" class="divide-y divide-gray-200 text-gray-900"></tbody>
      </table>
    </div>
  </main>

  <script>
    
    async function loadData(){
      const status = document.getElementById('status')
      const tbody = document.getElementById('rows')
      status.textContent = 'Loading...'
      status.className = 'text-gray-700'
      tbody.innerHTML = ''
      try {
        const list = JSON.parse(localStorage.getItem('registrations') || '[]')
        status.textContent = `${list.length} records (localStorage)`
        for (const r of list) {
          const tr = document.createElement('tr')
          tr.innerHTML = `
            <td class="px-3 py-2">${r.timestamp || ''}</td>
            <td class="px-3 py-2">${r.type || ''}</td>
            <td class="px-3 py-2">${r.enrollment_no || ''}</td>
            <td class="px-3 py-2">${r.name || ''}</td>
            <td class="px-3 py-2">${r.phone || r.parent_phone || ''}</td>
            <td class="px-3 py-2">${r.age || ''}</td>
            <td class="px-3 py-2">${r.employee_no || ''}</td>
            <td class="px-3 py-2">${r.last_class || ''}</td>
            <td class="px-3 py-2">${r.org_name || ''}</td>
            <td class="px-3 py-2">${r.org_addr || ''}</td>
            <td class="px-3 py-2">${r.parent_name || ''}</td>
            <td class="px-3 py-2">${r.parent_phone || ''}</td>
            <td class="px-3 py-2">${r.student_name || ''}</td>
            <td class="px-3 py-2">${r.student_class || ''}</td>
            <td class="px-3 py-2">${Array.isArray(r.competitions) ? r.competitions.join(', ') : (r.competitions || '')}</td>
          `
          tbody.appendChild(tr)
        }
      } catch (e) {
        status.textContent = 'Unable to read localStorage'
        status.className = 'text-red-700'
      }
    }
    loadData()

    const delBtn = document.getElementById('deleteAll')
    if (delBtn) delBtn.addEventListener('click', async () => {
      const status = document.getElementById('status')
      const ok = confirm('Clear ALL local registrations?')
      if (!ok) return
      try { localStorage.removeItem('registrations'); status.textContent = 'Cleared'; status.className = 'text-green-700'; await loadData() }
      catch (_) { status.textContent = 'Unable to clear'; status.className = 'text-red-700' }
    })

    const rosterAddBtn = document.getElementById('rosterAddBtn')
    if (rosterAddBtn) rosterAddBtn.addEventListener('click', async () => {
      const msg = document.getElementById('rosterMsg')
      msg.textContent = 'No backend configured'
      msg.className = 'ml-3 text-sm text-gray-700'
    })

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter(Boolean)
      if (!lines.length) return []
      const headers = lines[0].split(',').map(h => h.trim())
      const rows = []
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].match(/((?:^|,)(?:"(?:[^"]|"")*"|[^,]*))/g) || []
        const cells = parts.map(s => s.replace(/^,/, '').replace(/^"|"$/g, '').replace(/""/g, '"'))
        const obj = {}
        headers.forEach((h, idx) => { obj[h] = cells[idx] || '' })
        rows.push(obj)
      }
      return rows
    }

    async function sendRosterRows(rows) { return { okCount: 0, failCount: rows.length } }

    const rosterUploadBtn = document.getElementById('rosterUploadBtn')
    if (rosterUploadBtn) rosterUploadBtn.addEventListener('click', async () => {
      const fileInput = document.getElementById('rosterFile')
      const msg = document.getElementById('rosterUploadMsg')
      msg.textContent = ''
      msg.className = 'ml-3 text-sm'
      const file = fileInput && fileInput.files && fileInput.files[0]
      if (!file) { msg.textContent = 'Choose a file'; msg.className += ' text-red-700'; return }
      try {
        const name = file.name.toLowerCase()
        const text = await file.text()
        let rows = []
        if (name.endsWith('.json')) {
          const data = JSON.parse(text)
          rows = Array.isArray(data) ? data : (Array.isArray(data.rows) ? data.rows : [])
        } else {
          rows = parseCsv(text)
        }
        if (!rows.length) { msg.textContent = 'No rows found'; msg.className += ' text-red-700'; return }
        const res = await sendRosterRows(rows)
        msg.textContent = `Uploaded: ${res.okCount}, Failed: ${res.failCount}`
        msg.className += ' text-gray-700'
      } catch (_) { msg.textContent = 'Invalid file'; msg.className += ' text-red-700' }
    })
  </script>
</body>
</html>
