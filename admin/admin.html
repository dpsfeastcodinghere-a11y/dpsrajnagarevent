<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Registrations</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <header class="py-6 px-6 max-w-6xl mx-auto flex items-center justify-between">
    <div class="text-2xl font-bold text-blue-900">Admin Panel</div>
    <div class="flex items-center gap-3">
      <a href="../main/index.html" class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-white font-semibold hover:bg-green-700">Open Main</a>
      <a href="../main/index.html" class="inline-flex items-center rounded-md border border-blue-200 px-4 py-2 text-blue-700">Back</a>
    </div>
  </header>
  <main class="max-w-6xl mx-auto px-6">
    <div id="status" class="mb-3 text-sm"></div>

    <div class="mb-4 rounded-md border border-blue-200 bg-white p-4">
      <div class="text-blue-900 font-semibold mb-2">Admin PIN</div>
      <div class="flex items-center gap-3">
        <input id="pinInput" type="password" class="rounded-md border border-blue-300 px-2 py-1 w-40" placeholder="Enter PIN" />
        <button id="pinSetBtn" class="rounded-md bg-blue-600 px-3 py-1.5 text-white font-semibold hover:bg-blue-700">Set PIN</button>
        <button id="pinUnlockBtn" class="rounded-md bg-green-600 px-3 py-1.5 text-white font-semibold hover:bg-green-700 hidden">Unlock</button>
        <a id="openSheetBtn" target="_blank" class="hidden rounded-md bg-green-600 px-3 py-1.5 text-white font-semibold hover:bg-green-700">Open Sheet</a>
        <span id="pinMsg" class="ml-3 text-sm"></span>
      </div>
    </div>

    <div id="protectedContent" class="hidden">
      <div class="mb-4 rounded-md border border-blue-200 bg-white p-4">
        <div class="text-blue-900 font-semibold mb-2">Backend Settings</div>
        <div class="flex items-center gap-3">
          <input id="apiBaseInput" type="url" class="rounded-md border border-blue-300 px-2 py-1 w-full" placeholder="https://your-vercel-domain.vercel.app" />
          <button id="apiBaseSaveBtn" class="rounded-md bg-blue-600 px-3 py-1.5 text-white font-semibold hover:bg-blue-700">Save</button>
          <span id="apiBaseMsg" class="ml-3 text-sm"></span>
        </div>
        <div class="text-xs text-gray-600 mt-2">Enter Vercel URL (e.g. https://dpsrajnagarevent.vercel.app) to fetch from Database. Leave empty to use relative path (if hosted on Vercel).</div>
      </div>

      <div class="mb-4 rounded-md border border-blue-200 bg-white p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-blue-900 font-semibold">Data Actions</div>
        </div>
        <div class="flex items-center gap-3">
          <button id="refreshBtn" class="rounded-md bg-blue-600 px-3 py-1.5 text-white font-semibold hover:bg-blue-700">Refresh Data</button>
        </div>
        <div class="text-xs text-gray-600 mt-2">Fetches latest data from Database (PostgreSQL).</div>
      </div>

      <div class="overflow-x-auto rounded-md border border-gray-200 bg-white">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-3 py-2 text-left">Enrollment ID</th>
              <th class="px-3 py-2 text-left">Student Name</th>
              <th class="px-3 py-2 text-left">Phone</th>
              <th class="px-3 py-2 text-left">Email</th>
              <th class="px-3 py-2 text-left">Sector</th>
              <th class="px-3 py-2 text-left">Employee No</th>
              <th class="px-3 py-2 text-left">Timestamp</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-gray-200 text-gray-900"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // --- PIN Logic ---
    const pinInput = document.getElementById('pinInput')
    const pinSetBtn = document.getElementById('pinSetBtn')
    const pinUnlockBtn = document.getElementById('pinUnlockBtn')
    const pinMsg = document.getElementById('pinMsg')
    let isUnlocked = false

    function showLocked(){ const status=document.getElementById('status'); status.textContent='Enter Admin PIN to view data'; status.className='text-red-700' }
    async function hashPin(s){ const data=new TextEncoder().encode(s); const digest=await crypto.subtle.digest('SHA-256', data); return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('') }
    
    function updatePinUi(){ 
      const saved=localStorage.getItem('admin_pin_hash'); 
      if(saved){ 
        if(pinSetBtn) pinSetBtn.classList.add('hidden'); 
        if(pinUnlockBtn) pinUnlockBtn.classList.remove('hidden') 
      } else { 
        if(pinSetBtn) pinSetBtn.classList.remove('hidden'); 
        if(pinUnlockBtn) pinUnlockBtn.classList.add('hidden') 
      } 
    }

    function setProtected(visible){ 
      const p=document.getElementById('protectedContent'); 
      if(p) p.classList.toggle('hidden', !visible) 
    }

    async function initPin(){ 
      updatePinUi(); 
      const saved=localStorage.getItem('admin_pin_hash'); 
      const unlocked=sessionStorage.getItem('admin_unlocked')==='true'; 
      if(saved && unlocked){ 
        isUnlocked=true; 
        setProtected(true); 
        if(pinMsg){ pinMsg.textContent='Unlocked'; pinMsg.className='ml-3 text-sm text-green-700' }
        loadData();
      } else { 
        isUnlocked=false; 
        setProtected(false); 
        showLocked() 
      } 
    }
    initPin()

    if (pinSetBtn) pinSetBtn.addEventListener('click', async () => { 
      const v=(pinInput && pinInput.value || '').trim(); 
      if(!v){ pinMsg.textContent='Enter PIN'; pinMsg.className='ml-3 text-sm text-red-700'; return } 
      const h=await hashPin(v); 
      localStorage.setItem('admin_pin_hash', h); 
      sessionStorage.setItem('admin_unlocked','true'); 
      isUnlocked=true; 
      setProtected(true); 
      pinMsg.textContent='Saved'; 
      pinMsg.className='ml-3 text-sm text-green-700'; 
      updatePinUi(); 
      loadData() 
    })

    if (pinUnlockBtn) pinUnlockBtn.addEventListener('click', async () => { 
      const v=(pinInput && pinInput.value || '').trim(); 
      const saved=localStorage.getItem('admin_pin_hash')||''; 
      const h=await hashPin(v); 
      if(h===saved){ 
        sessionStorage.setItem('admin_unlocked','true'); 
        isUnlocked=true; 
        setProtected(true); 
        pinMsg.textContent='Unlocked'; 
        pinMsg.className='ml-3 text-sm text-green-700'; 
        loadData() 
      } else { 
        pinMsg.textContent='Wrong PIN'; 
        pinMsg.className='ml-3 text-sm text-red-700' 
      } 
    })

    // --- API Base Logic ---
    const apiBaseInput = document.getElementById('apiBaseInput')
    const apiBaseSaveBtn = document.getElementById('apiBaseSaveBtn')
    const apiBaseMsg = document.getElementById('apiBaseMsg')

    function getApiBase(){ try { return (localStorage.getItem('API_BASE') || '').trim() } catch(_) { return '' } }
    function initApiBase(){ const v=getApiBase(); if(apiBaseInput) apiBaseInput.value=v }
    initApiBase()

    if (apiBaseSaveBtn) apiBaseSaveBtn.addEventListener('click', () => { 
      const v=(apiBaseInput && apiBaseInput.value || '').trim(); 
      try { 
        if(v) localStorage.setItem('API_BASE', v); 
        else localStorage.removeItem('API_BASE'); 
        apiBaseMsg.textContent='Saved'; 
        apiBaseMsg.className='ml-3 text-sm text-green-700'; 
        loadData(); // Reload with new base
      } catch(_) { 
        apiBaseMsg.textContent='Unable to save'; 
        apiBaseMsg.className='ml-3 text-sm text-red-700' 
      } 
    })

    // --- Sheet URL Logic (Removed) ---
    // Removed as per request to delete Sheets integration

    // --- Load Data Logic ---
    const refreshBtn = document.getElementById('refreshBtn')
    if(refreshBtn) refreshBtn.addEventListener('click', loadData)

    async function loadData(){
      const status = document.getElementById('status')
      const tbody = document.getElementById('rows')
      if (!isUnlocked) return

      status.textContent = 'Loading data from Database...'
      status.className = 'text-gray-700'
      tbody.innerHTML = ''

      const base = getApiBase() || ''
      const url = base ? new URL('/api/enroll/all', base).toString() : '/api/enroll/all'
      
      try {
        const res = await fetch(url)
        if (!res.ok) throw new Error(`API Error: ${res.status}`)
        const json = await res.json()
        
        if (json.success && Array.isArray(json.data)) {
          status.textContent = `${json.data.length} records found`
          status.className = 'text-green-700'
          
          for (const r of json.data) {
            const tr = document.createElement('tr')
            tr.innerHTML = `
              <td class="px-3 py-2 border-b">${r.enrollmentId || ''}</td>
              <td class="px-3 py-2 border-b">${r.studentName || ''}</td>
              <td class="px-3 py-2 border-b">${r.phone || ''}</td>
              <td class="px-3 py-2 border-b">${r.email || ''}</td>
              <td class="px-3 py-2 border-b">${r.sector || ''}</td>
              <td class="px-3 py-2 border-b">${r.employeeNumber || ''}</td>
              <td class="px-3 py-2 border-b text-xs text-gray-500">${r.timestamp || ''}</td>
            `
            tbody.appendChild(tr)
          }
        } else {
          throw new Error(json.message || 'Invalid response')
        }
      } catch (e) {
        console.error(e)
        status.textContent = 'Unable to fetch data. Ensure "Backend Settings" URL is correct.'
        status.className = 'text-red-700'
      }
    }
  </script>
</body>
</html>
